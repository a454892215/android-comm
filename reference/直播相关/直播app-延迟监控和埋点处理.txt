
在专业直播 App（尤其是体育直播、电竞直播、互动直播）里，延迟监控上报通常会在 三个阶段埋点：
1️⃣ 数据接收阶段（Network / ExoPlayer 拉流阶段）
ExoPlayer 刚接收到视频/音频切片或 RTP/RTMP 帧数据的时刻
* **目的**：
  * 统计网络传输延迟（端到端延迟的一部分）
  * 判断网络是否慢或丢包
* **指标**：
  * 服务器推流时间戳 vs 客户端收到时间戳
  * 延迟 = `接收时间 - 服务器时间`
* **专业用途**：
  * 网络链路质量监控
  * CDN 节点性能分析
* **典型上报**：
  * 可能按切片/帧间隔上报
  * 或累积统计每秒平均延迟
---

### 2️⃣ 播放阶段（播放器播放时间点）
* **位置**：ExoPlayer 实际渲染帧时
* **目的**：获取真实延迟，判断是否解码耗时超标
* **指标**：
  * `player.getCurrentLiveOffset()`（或每帧时间戳计算）
  * 平均延迟、P95、最大延迟
* **专业用途**：
  * 用户体验监控
  * 追帧策略判断（当延迟过大时触发追帧）
* **典型上报**：
  * 每秒或每 N 秒上报一次
  * 异常延迟（> 阈值）立即上
---
### 3️⃣ 关键事件阶段（可选，但专业必备）
* **事件类型**：
  * 重缓冲（Buffering start/end）:
    a.网络原因: 1.下载速度低于当前码率, 2.丢包 / RTT 高, 3. CDN 节点抖动
             日志特征：分片下载耗时突然变长,连续 timeout / retry, bufferLevel 持续下降到 0
    在 **ExoPlayer** 里，要排查“网络原因导致的重缓冲”，可以通过几个关键组件和日志来获取。重点是获取 **分片下载耗时、超时重试、bufferLevel 变化**。下面我详细说明：
    ### 1️⃣ 使用 `AnalyticsListener` 获取播放关键事件
    ExoPlayer 提供了 `AnalyticsListener` 接口，可以监听几乎所有播放器事件，包括缓冲、加载、网络请求等。
    **说明：**
    * `onLoadStarted` / `onLoadCompleted` → 可以获取每个分片下载耗时。
    * `onLoadError` → 可以看到连续 timeout / retry 错误。
    * `onPlayerStateChanged` → 可以追踪 bufferLevel 持续下降的情况。
    **说明：**
    * `onBytesTransferred` 可以统计下载速度。
    * 通过对比 `onTransferStart` 与 `onTransferEnd` 时间，可以计算分片下载耗时。
    * 连续 timeout / retry 会触发 `onLoadError` 或 `IOException`。
    ---


    ### 4️⃣ 结合网络问题判断逻辑

    通过日志，可以做类似判断：

    ```text
    1. 分片下载耗时突然变长 → onLoadStarted/onLoadCompleted 时间差
    2. 连续 timeout / retry → onLoadError 连续出现 IOException
    3. bufferLevel 持续下降到 0 → getBufferedPercentage = 0
    ```


    b.解码速度慢（客户端性能瓶颈）1.网络正常，但 buffer 仍然下降, 2.解码队列积压  3.丢帧 / 追帧频繁
             日志特征：decode_time 明显升高, dropped_frames 增多,
             根据totalProcessingOffsetUs，判断，它表示：当前视频帧，相对于理想播放时间，已经“慢了多少时间”
    c.渲染或主线程阻塞:渲染慢,UI 卡顿,Surface 队列满
             日志特征：ender_time 异常，frame late
    d. 播放器策略问题: 1.minBuffer 太小 → 轻微抖动就空 2. maxBuffer 太大 → 延迟大，追帧困难
    e. 关键帧问题（I 帧间隔过大）: 丢包后长时间等不到下一个 I 帧, 快速追帧失败,长时间黑屏后缓冲
                              日志特征： waiting_for_key_frame long_gop_detected
  * 追帧/丢帧事件
  * 播放异常（花屏、黑屏）
  直播中的花屏，几乎都来自这 5 类问题之一：
  关键帧（I 帧）丢失或损坏，码流损坏 / 丢包未恢复
  解码器与码流参数不兼容，解码器状态错乱 / 复用错误，渲染层颜色格式 / stride 错误
  是的：现在主流直播系统，已经基本“用策略把花屏消灭掉了”， 代价是：宁愿短暂黑一下 / 停一下/ 或者直接跳帧，也尽量不让用户看到花屏。
  现在的硬解 / 软解，基本遵循：参考帧丢失，Slice 校验失败，NALU 不完整
  黑屏： “当前没有任何可渲染的视频帧”，数据“缺失 / 解码链路断了”，现代直播系统的设计目标是：宁可“停在最后一帧”，也尽量不“黑屏”
* **目的**：
  * 帮助后台判断延迟高的原因
  * 统计延迟与播放稳定性的关系
* **上报策略**：
  * 事件发生立即上报
  * 可配合平均延迟一起分析
---

一、上报策略原则
核心原则：节约带宽 + 只上报有价值数据
普通帧延迟、网络正常 → 不必每帧上报
异常或关键事件 → 必须上报
对应缓冲，卡顿，延迟超标等问题，也需要收集分析用户的网络状态。
对解码速度过慢，处理不过来，需要收集用户设备信息，当前CPU和内存负载信息。
统计 vs 上报
客户端可以每帧计算延迟，内部做统计（平均值、P95、最大值）
上报时只发送统计结果或异常事件，而不是每帧数据